(self.webpackChunk=self.webpackChunk||[]).push([[8797],{3905:(e,t,n)=>{"use strict";n.d(t,{Zo:()=>p,kt:()=>d});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),d=i,m=u["".concat(l,".").concat(d)]||u[d]||h[d]||o;return n?a.createElement(m,r(r({ref:t},p),{},{components:n})):a.createElement(m,r({ref:t},p))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,r[1]=s;for(var c=2;c<o;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},5880:(e,t,n)=>{"use strict";n.r(t),n.d(t,{frontMatter:()=>s,metadata:()=>l,toc:()=>c,default:()=>h});var a=n(2122),i=n(9756),o=(n(7294),n(3905)),r=["components"],s={author:"Chris Kipp",title:"A Dive into Configuring Metals",authorURL:"https://twitter.com/ckipp01",authorImageURL:"https://avatars1.githubusercontent.com/u/13974112?s=400&u=7b6a2ddab8eec6f99e4e40ae9b81f71cb5ba92e5&v=4"},l={permalink:"/metals/blog/2020/07/23/configuring-a-client",source:"@site/blog/2020-07-23-configuring-a-client.md",title:"A Dive into Configuring Metals",description:"As of this last Metals release, it's now 100% possible to fully configure Metals",date:"2020-07-23T00:00:00.000Z",formattedDate:"July 23, 2020",tags:[],readingTime:6.97,truncated:!1,prevItem:{title:"Metals v0.9.3 - Lithium",permalink:"/metals/blog/2020/08/19/lithium"},nextItem:{title:"Metals v0.9.2 - Lithium",permalink:"/metals/blog/2020/07/15/lithium"}},c=[{value:"The first configuration",id:"the-first-configuration",children:[]},{value:"User configuration",id:"user-configuration",children:[]},{value:"Experimental",id:"experimental",children:[]},{value:"InitializationOptions",id:"initializationoptions",children:[]},{value:"Are there still server properties?",id:"are-there-still-server-properties",children:[]},{value:"Conclusion",id:"conclusion",children:[]}],p={toc:c};function h(e){var t=e.components,n=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"As of this last Metals release, it's now 100% possible to fully configure Metals\nwithout any need to pass in server properties. Depending on your editor of\nchoice, the process to configure Metals may be completely abstracted away. You\nsimply click install, wait a bit, and start coding. In this post I'd like to\ntalk a bit about the progression of how Metals was originally configured fully\nwith server properties and how it can now be fully configured via the client,\nwhich in ",(0,o.kt)("a",{parentName:"p",href:"https://microsoft.github.io/language-server-protocol/"},"LSP")," terms is\nyour editor. This can serve both as a guide for those client extension\nmaintainers out there and also those curious at how Metals correctly works for\nall the various editors."),(0,o.kt)("h2",{id:"the-first-configuration"},"The first configuration"),(0,o.kt)("p",null,"Looking back to the Fall of 2018, you see a giant glimpse of Metals becoming\nwhat it is today when looking at a giant commit by\n",(0,o.kt)("a",{parentName:"p",href:"https://twitter.com/olafurpg"},"@olafurpg")," with the title ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/scalameta/metals/commit/df6b41acaad1978ffd1fa25c41909c38425932ab"},"Implement pretty\nbasic language server and build\nclient."),".\nIt's a pretty fascinating commit to look at if you're interested in the\nbeginnings of Metals, but I want to focus in on a specific file that still exists\ntoday, which is the\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/scalameta/metals/commit/df6b41acaad1978ffd1fa25c41909c38425932ab#diff-dc72b5c684177c884881164ab17182eb"},"MetalsServerConfig.scala"),".\nIn this file you see the first configuration options that existed for Metals.\nYou see things like ",(0,o.kt)("inlineCode",{parentName:"p"},"isLogShowMessage")," to ensure users were correctly getting\nstatus messages instead of everything just going into the logs. (This was also\nbefore\n",(0,o.kt)("a",{parentName:"p",href:"https://scalameta.org/metals/docs/integrations/new-editor#metalsstatus"},(0,o.kt)("inlineCode",{parentName:"a"},"metals/status")),"\nexisted which is used today for a better status experience in Metals). You also\nsee other options like ",(0,o.kt)("inlineCode",{parentName:"p"},"isHttpEnabled")," for Metals to start the Doctor for those\nthat needed an HTTP client interface, or even an ",(0,o.kt)("inlineCode",{parentName:"p"},"icons")," setting to ensure\nthings looked nice and matched your client. At this point, instead of just\nhaving the user specify every one of these when they bootstrapped the server, a\n",(0,o.kt)("inlineCode",{parentName:"p"},"metals.client")," property was introduced that we could give editors a set of\ndefaults. Here is an example for the first settings for Vim and Metals using the\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/natebosch/vim-lsc"},"vim-lsc")," plugin:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-scala"},'System.getProperty("metals.client", "unknown") match {\n  case "vim-lsc" =>\n    MetalsServerConfig().copy(\n      isExtensionsEnabled = false,\n      fileWatcher = FileWatcherConfig.auto,\n      isLogStatusBar = true,\n      isNoInitialized = true,\n      isHttpEnabled = true,\n      icons = Icons.unicode\n    )\n  ...\n')),(0,o.kt)("p",null,"The property would then be set when the user would bootstrap Metals. This\nstarted out as a manual process for almost all the editors utilizing\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/coursier/coursier"},"Coursier"),". This still actually remains a\nvalid way to configure Metals, although not recommended if your client supports\nsetting ",(0,o.kt)("inlineCode",{parentName:"p"},"InitializationOptions")," in the\n",(0,o.kt)("a",{parentName:"p",href:"https://microsoft.github.io/language-server-protocol/specifications/specification-current/#initialize"},(0,o.kt)("inlineCode",{parentName:"a"},"initalize")),"\nrequest. It's also almost the identical process that happens behind the scenes\nwhen client extensions like\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/scalameta/metals-vscode"},"metals-vscode"),",\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/scalameta/coc-metals"},"coc-metals"),", and\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/scalameta/metals-sublime"},"metals-sublime")," bootstrap the\nserver for you. For example, here is how you would manually do this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"coursier bootstrap \\\n  --java-opt -Xss4m \\\n  --java-opt -Xms100m \\\n  --java-opt -Dmetals.client=emacs \\\n  org.scalameta:metals_2.12:0.9.2 \\\n  -r bintray:scalacenter/releases \\\n  -r sonatype:snapshots \\\n  -o /usr/local/bin/metals-emacs -f\n")),(0,o.kt)("p",null,"In the above example, you would then get the defaults specified in\n",(0,o.kt)("inlineCode",{parentName:"p"},"MetalsServerConfig.scala")," for ",(0,o.kt)("inlineCode",{parentName:"p"},"emacs"),". Again, when the process is automated\nit's very similar, and you can see this if you poke around the\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/scalameta/metals-vscode/blob/master/src/extension.ts#L166"},(0,o.kt)("inlineCode",{parentName:"a"},"fetchAndLaunchMetals")),"\nfunction in the VS-Code extension. You can see how the path to Coursier is\ngrabbed, your ",(0,o.kt)("inlineCode",{parentName:"p"},"JAVA_HOME")," is captured, and how we get some extra\nvariables/properties to call Metals with."),(0,o.kt)("h2",{id:"user-configuration"},"User configuration"),(0,o.kt)("p",null,"Apart from server properties, it was also necessary for users to be able to\neasily change a setting, even while in the editor. For example, we have a\ncurrent setting ",(0,o.kt)("inlineCode",{parentName:"p"},"metals.superMethodLensesEnabled")," which when enabled will\ndisplay a code lens that when invoked will either go to the parent class\ncontaining the definition of the method or symbol or display the full method\nhierarchy allowing you to choose where to go. "),(0,o.kt)("p",null,"Here is an example of what this looks like in Vim:\n",(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/rEvhzG1.png",alt:"Super Method Hierarchy"})),(0,o.kt)("p",null,"This feature is actually turned off by default since in very large code bases\nyou may experience a lag. So if a user wanted to turn this on, it wouldn't be a\ngreat user experience to have to re-bootstrap the server to enable this feature.\nThis is where the User Configuration comes into play by being able to change a\nconfiguration value and notify the server via\n",(0,o.kt)("a",{parentName:"p",href:"https://microsoft.github.io/language-server-protocol/specification#workspace_didChangeConfiguration"},(0,o.kt)("inlineCode",{parentName:"a"},"workspace/didChangeConfiguration")),".\nThis can fully happen for most of the user configuration values without any need\nto restart the server. You can see the first configuration options added this\nway in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/scalameta/metals/commit/f4706ec75afb9bf797e3144f4a0e91bb0b186e07"},"this\ncommit"),"\nwhere the ability to define your ",(0,o.kt)("inlineCode",{parentName:"p"},"JAVA_HOME")," was added. With now allowing for\nuser configurations in Metals, this allowed for an even more customized\nexperience."),(0,o.kt)("h2",{id:"experimental"},"Experimental"),(0,o.kt)("p",null,"Being able to customize the server with properties and allowing users to pass in\nsome configuration values worked great. However, once Metals started creating\nLSP extensions for functionality that wasn't supported fully just by LSP, then a\nway was needed for the client to express that it supported these extensions.\nThis is when Metals started to use the\n",(0,o.kt)("a",{parentName:"p",href:"https://microsoft.github.io/language-server-protocol/specifications/specification-current/#initialize"},(0,o.kt)("inlineCode",{parentName:"a"},"ClientCapabilities.experimental")),"\nfield which the client needed to declare support the extension. You can see the\nfirst inklings of this when the ",(0,o.kt)("a",{parentName:"p",href:"https://scalameta.org/metals/docs/editors/tree-view-protocol.html"},"Tree View\nProtocol")," was\nintroduced ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/scalameta/metals/commit/a55a2413ef10237c8510eb707c0de0cd03b83d85#diff-f8c05eebbf12c9c21a7d568f09b500ea"},"here in this\ncommit"),".\nThis then continued to be further expanded as we introduced more extensions."),(0,o.kt)("p",null,"As it became easier for various clients to set this, we slowly ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/scalameta/metals/pull/1414"},"started to\nmigrate")," other options that could\nonly be previously set via server properties to\n",(0,o.kt)("inlineCode",{parentName:"p"},"ClientCapabilities.experimental"),". So settings like which format you'd like the\nDoctor to return could now be set directly by the client without need to\nbootstrap the server with a specific property. This allowed for much easier\nconfiguration than was previously had."),(0,o.kt)("h2",{id:"initializationoptions"},"InitializationOptions"),(0,o.kt)("p",null,"Once it was clear that configuring Metals via the client was desirable, a closer\nlook was taken at ",(0,o.kt)("inlineCode",{parentName:"p"},"InitializationOptions")," that can be passed in during the\n",(0,o.kt)("a",{parentName:"p",href:"https://microsoft.github.io/language-server-protocol/specifications/specification-current/#initialize"},(0,o.kt)("inlineCode",{parentName:"a"},"initialize")),"\nrequest. Since any value is able to be passed in this way, a decision was made\nto fully migrate all the possible settings that were previously set as server\nproperties (except a select few that we'll touch on later), and also move all\nthe of settings that could be set under ",(0,o.kt)("inlineCode",{parentName:"p"},"experimental")," to\n",(0,o.kt)("inlineCode",{parentName:"p"},"InitializationOptions")," as well. This ultimately allows for clients to fully\nconfigured Metals via ",(0,o.kt)("inlineCode",{parentName:"p"},"InitializationOptions")," without the need to set any server\nproperties. In theory this also meant that you could not use the same Metals\nexecutable for VS Code, Vim, or Emacs since the server is fully being configured\nby the client itself. The current settings that can be passed in and their\ndefaults are explained in detail ",(0,o.kt)("a",{parentName:"p",href:"https://scalameta.org/metals/docs/integrations/new-editor#initializationoptions"},"here on the\nwebsite"),",\nbut the interface is as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'interface MetalsInitializationOptions {\n  compilerOptions?: CompilerInitializationOptions;\n  debuggingProvider?: boolean;\n  decorationProvider?: boolean;\n  didFocusProvider?: boolean;\n  doctorProvider?: "json" | "html";\n  executeClientCommandProvider?: boolean;\n  globSyntax?: "vscode" | "uri";\n  icons?: "vscode" | "octicons" | "atom" | "unicode";\n  inputBoxProvider?: boolean;\n  isExitOnShutdown?: boolean;\n  isHttpEnabled?: boolean;\n  openFilesOnRenameProvider?: boolean;\n  quickPickProvider?: boolean;\n  renameFileThreshold?: number;\n  slowTaskProvider?: boolean;\n  statusBarProvider?: "on" | "off" | "log-message" | "show-message";\n  treeViewProvider?: boolean;\n  openNewWindowProvider?: boolean;\n}\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'interface CompilerInitializationOptions {\n  completionCommand?: string;\n  isCompletionItemDetailEnabled?: boolean;\n  isCompletionItemDocumentationEnabled?: boolean;\n  isCompletionItemResolve?: boolean;\n  isHoverDocumentationEnabled?: boolean;\n  isSignatureHelpDocumentationEnabled?: boolean;\n  overrideDefFormat?: "ascii" | "unicode";\n  parameterHintsCommand?: string;\n  snippetAutoIndent?: boolean;\n}\n')),(0,o.kt)("p",null,"You'll notice that this allows for a much finer grained configuration if the\nclient chooses to set certain values. Everything from whether or not the Scala\nPresentation Compiler should populate the ",(0,o.kt)("inlineCode",{parentName:"p"},"SignatureHelp.documentation")," to\nwhether or not the editor supports opening a new window after using the\n",(0,o.kt)("inlineCode",{parentName:"p"},"metals.new-scala-project")," command can now be easily configured. Fully\nconfiguring Metals through ",(0,o.kt)("inlineCode",{parentName:"p"},"InitializationOptions")," is now the recommended way to\nconfigure Metals."),(0,o.kt)("h2",{id:"are-there-still-server-properties"},"Are there still server properties?"),(0,o.kt)("p",null,"While all of the old server properties still exist for Metals, it's no longer\nrecommended to use them to configure Metals. However, there are still a few\nserver properties that remain only server properties since they are not meant to\nbe widely used, and aren't exactly recommended to use for the average user. You\ncan see an up to date list of these ",(0,o.kt)("a",{parentName:"p",href:"https://scalameta.org/metals/docs/integrations/new-editor#metals-server-properties"},"here on the\nwebsite"),"\nand what functionality they provide."),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"As of Metals 0.9.2 it's fully possibly for all clients to use a default\nbootstrapped Metals that can fully be configured via ",(0,o.kt)("inlineCode",{parentName:"p"},"InitializationOptions"),".\nThere is a freshly updated ",(0,o.kt)("a",{parentName:"p",href:"https://scalameta.org/metals/docs/editors/new-editor.html"},"Integrating a new\neditor")," section on\nthe website to help explain how to exactly configure a client for usage with\nMetals. As always, don't hesitate to reach out on any of the various channels\nlocated in the footer or submit an issue to either improve documentation or to\nlog a bug. Also as a reminder, there is a separate repo for\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/scalameta/metals-feature-requests"},"metals-feature-requests"),"."),(0,o.kt)("p",null,"Happy coding with Metals!"))}h.isMDXComponent=!0}}]);