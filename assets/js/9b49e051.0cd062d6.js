"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["7743"],{69995:function(e,n,i){i.r(n),i.d(n,{frontMatter:()=>l,toc:()=>d,default:()=>h,metadata:()=>t,assets:()=>a,contentTitle:()=>r});var t=JSON.parse('{"id":"integrations/new-build-tool","title":"Integrating a new build tool","description":"Metals uses the","source":"@site/target/docs/integrations/new-build-tool.md","sourceDirName":"integrations","slug":"/integrations/new-build-tool","permalink":"/metals/docs/integrations/new-build-tool","draft":false,"unlisted":false,"editUrl":"https://github.com/scalameta/metals/edit/main/docs/integrations/new-build-tool.md","tags":[],"version":"current","lastUpdatedBy":null,"lastUpdatedAt":null,"frontMatter":{"id":"new-build-tool","title":"Integrating a new build tool"},"sidebar":"docs","previous":{"title":"Making a release","permalink":"/metals/docs/contributors/releasing"},"next":{"title":"Integrating a new editor","permalink":"/metals/docs/integrations/new-editor"}}'),s=i(74848),o=i(84429);let l={id:"new-build-tool",title:"Integrating a new build tool"},r,a={},d=[{value:"Enable SemanticDB",id:"enable-semanticdb",level:2},{value:"Recommended compiler options",id:"recommended-compiler-options",level:2},{value:"Bloop build server",id:"bloop-build-server",level:2},{value:"Custom build server",id:"custom-build-server",level:2},{value:"Server discovery",id:"server-discovery",level:3},{value:"Library bindings",id:"library-bindings",level:3},{value:"Manual tests",id:"manual-tests",level:3},{value:"Automated tests",id:"automated-tests",level:3},{value:"BSP endpoints",id:"bsp-endpoints",level:3}];function c(e){let n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["Metals uses the\n",(0,s.jsx)(n.a,{href:"https://github.com/scalacenter/bsp/blob/master/docs/bsp.md",children:"Build Server Protocol"}),"\n(BSP) to communicate with build tools. Any build tool that implements the\nprotocol should work with Metals."]}),"\n",(0,s.jsx)(n.p,{children:"There are two options for integrating Metals with a new build tool:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"#bloop-build-server",children:"via Bloop"}),": emit Bloop JSON configuration files and use\nthe Bloop build server. The benefit of this approach is that it's simple to\nimplement but has the downside that compilation happens outside of your build\ntool."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"#custom-build-server",children:"via custom build server"}),": add Build Server Protocol\nsupport to your build tool. The benefit of this approach is that Metals\nintegrates directly with your build tool, reproducing the same build\nenvironment as your current workflow. The downside of this approach is that it\nmost likely requires more effort compared to emitting Bloop JSON files."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"enable-semanticdb",children:"Enable SemanticDB"}),"\n",(0,s.jsx)(n.p,{children:"If you use the Bloop build server there is nothing that needs to be added in\norder to enable SemanticDB. Metals itself will communicate with Bloop to make\nsure proper options are enabled."}),"\n",(0,s.jsxs)(n.p,{children:["Otherwise, if you implement a custom build server, the\n",(0,s.jsx)(n.a,{href:"https://scalameta.org/docs/semanticdb/guide.html",children:"SemanticDB"})," compiler plugin\nis required for Metals code navigation to work. Only limited Metals features\nlike diagnostics and code formatting will work without the SemanticDB compiler\nplugin enabled."]}),"\n",(0,s.jsx)(n.p,{children:'Users get a warning from Metals when the build server does not enable the\nSemanticDB compiler plugin. Users have an option to suppress this warning by\nselecting a "Don\'t show again" option.'}),"\n",(0,s.jsxs)(n.p,{children:["Make sure to declare the compiler option ",(0,s.jsx)(n.code,{children:'"-P:semanticdb:sourceroot:$WORKSPACE"'}),"\nwhere ",(0,s.jsx)(n.code,{children:"$WORKSPACE"})," is the absolute path to the workspace root directory. By\ndefault, the sourceroot is inferred from the working directory of the compiler\nprocess, but it's better to explicitly declare it. If the sourceroot is\nmisconfigured, then Metals is unable to find the SemanticDB files created by the\ncompiler plugin."]}),"\n",(0,s.jsx)(n.h2,{id:"recommended-compiler-options",children:"Recommended compiler options"}),"\n",(0,s.jsx)(n.p,{children:"We recommend you update the following compiler options when using Metals:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"-Xlint"}),": these warnings are helpful in the editor even if you don't have them\nenabled in your main build. Consult ",(0,s.jsx)(n.code,{children:"scalac -Xlint:help"})," for a full list of\navailable warnings."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"-Xfatal-warnings"}),": disable this setting even if you have it enabled in your\nmain build. Fatal warnings prevent code navigation from working when there are\nwarnings like 'unused import'."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"bloop-build-server",children:"Bloop build server"}),"\n",(0,s.jsxs)(n.p,{children:["Consult the\n",(0,s.jsx)(n.a,{href:"https://scalacenter.github.io/bloop/docs/configuration-format/",children:"Bloop configuration format"}),'\nto learn how to emit Bloop JSON files. Once the JSON files have been generated,\nuse "',(0,s.jsx)(n.a,{href:"/metals/docs/integrations/new-editor#import-build",children:"Connect to build server"}),'" server\ncommand in Metals to establish a connection with Bloop.']}),"\n",(0,s.jsx)(n.h2,{id:"custom-build-server",children:"Custom build server"}),"\n",(0,s.jsxs)(n.p,{children:["Consult the\n",(0,s.jsx)(n.a,{href:"https://github.com/scalacenter/bsp/blob/master/docs/bsp.md",children:"BSP specification"}),"\nto learn about the protocol in detail."]}),"\n",(0,s.jsx)(n.h3,{id:"server-discovery",children:"Server discovery"}),"\n",(0,s.jsxs)(n.p,{children:["Metals automatically connects to a BSP server if the workspace root directory\ncontains a ",(0,s.jsx)(n.code,{children:".bsp/$name.json"}),' file. For example, a build tool named "Bill" will\nhave a ',(0,s.jsx)(n.code,{children:".bsp/bill.json"})," file with the following information."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "name": "Bill",\n  "version": "1.0.0",\n  "bspVersion": "2.0.0",\n  "languages": ["scala"],\n  "argv": ["bill", "bsp"]\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["When Metals detects a ",(0,s.jsx)(n.code,{children:".bsp/bill.json"})," file in the workspace:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["it starts a new process ",(0,s.jsx)(n.code,{children:"bill bsp"}),", the command is derived from the ",(0,s.jsx)(n.code,{children:"argv"}),"\nfield in ",(0,s.jsx)(n.code,{children:"bill.json"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"the working directory of the process is the workspace directory."}),"\n",(0,s.jsx)(n.li,{children:"communication between Metals and the build server happens through standard\ninput/output."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["For a plug-and-play example of a build server, see ",(0,s.jsx)(n.code,{children:"Bill.scala"})," in the Metals\nrepository. Bill is a basic build server that is used for testing and\ndemonstration purposes only."]}),"\n",(0,s.jsx)(n.h3,{id:"library-bindings",children:"Library bindings"}),"\n",(0,s.jsx)(n.p,{children:"There are two available libraries to implement a BSP server:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ch.epfl.scala:bsp4j"}),": A Java library built with Java ",(0,s.jsx)(n.code,{children:"CompletableFuture"})," for\nasync primitives and GSON for JSON serialization. This module is used by\nMetals and the IntelliJ Scala plugin."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ch.epfl.scala:bsp4s"}),": A Scala library built with Monix ",(0,s.jsx)(n.code,{children:"Task"}),"/",(0,s.jsx)(n.code,{children:"Observable"}),"\nfor async primitives and Circe for JSON for serialization. This module is used\nby the Bloop build server."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Both libraries are compatible with each other. For example, it's OK to implement\na server with bsp4j and a client in bsp4s."}),"\n",(0,s.jsx)(n.h3,{id:"manual-tests",children:"Manual tests"}),"\n",(0,s.jsx)(n.p,{children:"You can manually test your build server integration by running Metals with your\neditor of choice."}),"\n",(0,s.jsx)(n.p,{children:"Create the following trace files to spy on incoming/outgoing JSON communication\nbetween Metals and your build tool."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"# macOS\ntouch ~/Library/Caches/org.scalameta.metals/bsp.trace.json\n# Linux\ntouch ~/.cache/metals/bsp.trace.json\n"})}),"\n",(0,s.jsx)(n.p,{children:"Metals must re-start to pick up the trace file."}),"\n",(0,s.jsx)(n.h3,{id:"automated-tests",children:"Automated tests"}),"\n",(0,s.jsxs)(n.p,{children:["The Metals repository has infrastructure for running end-to-end integration\ntests with build servers. To test your build server integration, you can to\nclone the repository and write custom tests under\n",(0,s.jsx)(n.code,{children:"tests/unit/src/test/scala/tests"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["If there is interest, we can publish a Metals ",(0,s.jsx)(n.code,{children:"testkit"})," module to make it\npossible to write tests outside the Metals repository."]}),"\n",(0,s.jsx)(n.h3,{id:"bsp-endpoints",children:"BSP endpoints"}),"\n",(0,s.jsx)(n.p,{children:"Metals requires the following BSP endpoints to be implemented by the build\nserver."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"workspace/buildTargets"}),": to list all the build targets in the workspace."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"buildTarget/scalacOptions"}),": to know the classpath and compiler options used\nto compile the project sources."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"buildTarget/sources"}),": to know what source files map to which build targets."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"buildTarget/dependencySources"}),': to support "Goto definition" for external\nlibraries.']}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"buildTarget/compile"}),": to trigger compilation in a build target."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Additionally, Metals expects the server to send the following notifications:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"buildTarget/publishDiagnostics"}),": To report compile errors and warnings in the\neditor buffer."]}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},84429:function(e,n,i){i.d(n,{R:()=>l,x:()=>r});var t=i(96540);let s={},o=t.createContext(s);function l(e){let n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);