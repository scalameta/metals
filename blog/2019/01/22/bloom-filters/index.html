<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/metals/blog/rss.xml" title="Metals Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/metals/blog/atom.xml" title="Metals Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-140140828-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-140140828-1",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Metals" href="/metals/opensearch.xml"><title data-react-helmet="true">Low-memory symbol indexing with bloom filters | Metals</title><meta data-react-helmet="true" property="og:title" content="Low-memory symbol indexing with bloom filters | Metals"><meta data-react-helmet="true" name="description" content="The latest Metals release introduces three new in-memory indexes to implement"><meta data-react-helmet="true" property="og:description" content="The latest Metals release introduces three new in-memory indexes to implement"><meta data-react-helmet="true" property="og:url" content="http://scalameta.org/metals/blog/2019/01/22/bloom-filters"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:image" content="http://scalameta.org/metals/img/scalameta-logo.png"><meta data-react-helmet="true" name="twitter:image" content="http://scalameta.org/metals/img/scalameta-logo.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/metals/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://scalameta.org/metals/blog/2019/01/22/bloom-filters"><link data-react-helmet="true" rel="alternate" href="http://scalameta.org/metals/blog/2019/01/22/bloom-filters" hreflang="en"><link data-react-helmet="true" rel="alternate" href="http://scalameta.org/metals/blog/2019/01/22/bloom-filters" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/metals/assets/css/styles.6fd03f5c.css">
<link rel="preload" href="/metals/assets/js/runtime~main.4cac7cd7.js" as="script">
<link rel="preload" href="/metals/assets/js/main.3a707c2e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/metals/"><img src="/metals/img/scalameta-logo.png" alt="Metals" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/metals/img/scalameta-logo.png" alt="Metals" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Metals</strong></a><a class="navbar__item navbar__link" href="/metals/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/metals/blog/">Blog</a><a href="https://github.com/scalameta/metals" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">üåô</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">‚òÄÔ∏è</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/metals/"><img src="/metals/img/scalameta-logo.png" alt="Metals" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/metals/img/scalameta-logo.png" alt="Metals" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Metals</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/metals/docs/">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/metals/blog/">Blog</a></li><li class="menu__list-item"><a href="https://github.com/scalameta/metals" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">All Blog Posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2021/07/14/tungsten">Metals v0.10.5 - Tungsten</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2021/05/31/tungsten">Metals v0.10.4 - Tungsten</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2021/05/17/tungsten">Metals v0.10.3 - Tungsten</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2021/04/20/tungsten">Metals v0.10.2 - Tungsten</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2021/04/06/tungsten">Metals v0.10.1 - Tungsten</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2021/02/24/tungsten">Metals v0.10.0 - Tungsten</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2021/02/02/metals-retro-part1">A Metals Retrospective (Part 1)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2021/01/19/lithium">Metals v0.9.10 - Lithium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/12/19/lithium">Metals v0.9.8 - Lithium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/11/26/lithium">Metals v0.9.7 - Lithium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/11/20/lithium">Metals v0.9.6 - Lithium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/11/10/lithium">Metals v0.9.5 - Lithium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/11/06/sbt-BSP-support">sbt BSP support</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/09/21/lithium">Metals v0.9.4 - Lithium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/08/19/lithium">Metals v0.9.3 - Lithium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/07/23/configuring-a-client">A Dive into Configuring Metals</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/07/15/lithium">Metals v0.9.2 - Lithium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/07/01/lithium">Metals v0.9.1 - Lithium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/05/04/lithium">Metals v0.9.0 - Lithium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/04/12/mercury">Metals v0.5.0 (Redirect)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/04/10/cobalt">Metals v0.8.4 - Cobalt</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/03/19/cobalt">Metals v0.8.3 - Cobalt</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/02/26/cobalt">Metals v0.8.1 - Cobalt</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2020/01/10/cobalt">Metals v0.8.0 - Cobalt</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2019/09/23/thorium">Metals v0.7.6 - Thorium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2019/09/12/thorium">Metals v0.7.5 - Thorium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2019/09/02/thorium">Metals v0.7.2 - Thorium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2019/06/28/thorium">Metals v0.7.0 - Thorium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2019/06/11/radium">Metals v0.6.1 - Radium</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2019/04/26/mercury">Metals v0.5.1 - Mercury</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2019/04/12/mercury">Metals v0.5.0 - Mercury</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2019/02/01/tin">Metals v0.4.4 - Tin</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2019/01/24/tin">Metals v0.4.0 - Tin</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/metals/blog/2019/01/22/bloom-filters">Low-memory symbol indexing with bloom filters</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2018/12/14/iron">Metals v0.3.2 - Iron</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2018/12/12/fast-goto-definition">Fast goto definition with low memory footprint</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/metals/blog/2018/12/06/iron">Metals v0.3 - Iron</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="margin-bottom--sm blogPostTitle_GeHD">Low-memory symbol indexing with bloom filters</h1><div class="margin-vert--md"><time datetime="2019-01-22T00:00:00.000Z" class="blogPostDate_fNvV">January 22, 2019 ¬∑ 13 min read</time></div><div class="avatar margin-vert--md"><a href="https://twitter.com/olafurpg" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars2.githubusercontent.com/u/1408093?s=460&amp;v=4" alt="√ìlafur P√°ll Geirsson"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://twitter.com/olafurpg" target="_blank" rel="noopener noreferrer">√ìlafur P√°ll Geirsson</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p>The latest Metals release introduces three new in-memory indexes to implement
the features &quot;find symbol references&quot; and &quot;fuzzy symbol search&quot;. Indexes are
important to provide fast response times for user requests but they come at the
price of higher memory usage. To keep memory usage low, Metals uses a data
structure called bloom filters that implements space-efficient sets. Thanks to
bloom filters, the three new indexes added in the last release use only a few
megabytes of memory even for large projects with &gt;500k lines of code.</p><p>In this post, we look into how Metals uses bloom filters for fast indexing with
small memory footprint. We explain what bloom filters are and how we can encode
problems like fuzzy searching to take advantage of the nice properties of bloom
filters. Finally, we evaluate these new features on a real-world project: the
<a href="https://github.com/akka/akka" target="_blank" rel="noopener noreferrer">Akka</a> build.</p><p>The work presented in this post was done as part of my job at the
<a href="https://scala.epfl.ch/" target="_blank" rel="noopener noreferrer">Scala Center</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="bloom-filters"></a>Bloom filters<a class="hash-link" href="#bloom-filters" title="Direct link to heading">#</a></h2><p><a href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank" rel="noopener noreferrer">Bloom filters</a> are a probabilistic
data structure that implements space-efficient sets. The difference between a
bloom filter and a regular set such as <code>HashSet</code> is that bloom filters have the
following limitations:</p><ul><li>the <code>contains(element)</code> method may return false positives, meaning it can
occasionally return true even when the element is not a member of the set.</li><li>when creating a bloom filter, you must provide an estimate for how many
elements will be added to the set. A large estimate results in lower false
positive rates for the <code>contains(element)</code> method at the cost of higher space
usage. Conversely, a low estimate results in lower memory usage at the cost of
higher false positives for the <code>contains(element)</code> method.</li><li>you can&#x27;t iterate through the elements of a bloom filter.</li></ul><p>In exchange for these limitations, bloom filters are able to compress a large
number of elements into a small number of bits. Due to their space-efficiency,
bloom filters are used in many applications ranging from browsers, CDNs and
cryptocurrencies. In the next sections, we&#x27;ll explore how bloom filters can also
be used in the context of a language server like Metals.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="find-symbol-references"></a>Find symbol references<a class="hash-link" href="#find-symbol-references" title="Direct link to heading">#</a></h2><p>The &quot;find symbol references&quot; feature shows all usages of a given symbol. For
example, in the demo below we find 843 references to the method <code>Actor.sender()</code>
in the Akka build.</p><p><img src="https://user-images.githubusercontent.com/1408093/51531254-3a368280-1e3d-11e9-8df2-4560c6294e35.gif" alt="Find symbol references example"></p><p>Find symbol references is helpful for users when exploring a codebase and it&#x27;s
also an important component for Metals to implement other features down the road
such as &quot;rename symbol&quot;.</p><p>The challenge when implementing find references is that large projects have many
symbol references. Iterating through all symbol references for every source file
on every request is too slow. Most symbols appear only in a few source files so
we need some way to reduce the search space.</p><p>Metals uses bloom filters to reduce the number of files we search when looking
for a symbol reference. For every file on disk, we keep an in-memory bloom
filter which contains the set of all referenced symbols in that file. When
looking for references to a given symbol, we skip files¬†when their accompanying
bloom filter does not contain a reference to that symbol. False positive results
from the bloom filter are not a problem¬†because they only slow down the response
but don&#x27;t compromise the correctness of the final result.</p><p>Concretely, Metals keeps an in-memory map where keys are paths to source files
in the workspace.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val references: Map[Path, BloomFilter[Symbol]]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The values represent the set of
<a href="https://scalameta.org/docs/semanticdb/specification.html" target="_blank" rel="noopener noreferrer">SemanticDB symbols</a>
referenced in that file. A nice property of keying the map by file paths is that
we can incrementally update the map as files change. When a file is re-compiled
producing a new SemanticDB file, we throw out the old bloom filter and compute a
new one from scratch.</p><p>To implement the search, we iterate through all entries of the map and only read
SemanticDB files from disk when their accompanying bloom filter contains the
query symbol (recap: false positives are OK).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val query = // ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">for {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (path, bloom) &lt;- references</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if bloom.mightContain(query)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  symbolOccurrence &lt;- readSemanticdbOccurrences(path) // read from disk</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if isSameSymbol(query, symbolOccurrence)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} yield symbolOccurrence</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>In the actual Metals implementation, we additionally take care of adjusting
positions of the results in case the source file contents have changed since the
SemanticDB file was created.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="fuzzy-symbol-search"></a>Fuzzy symbol search<a class="hash-link" href="#fuzzy-symbol-search" title="Direct link to heading">#</a></h2><p>The &quot;fuzzy symbol search&quot; feature allows you to navigate to a symbol definition
in the workspace sources or library dependencies by typing the symbol&#x27;s name.</p><p><img src="https://user-images.githubusercontent.com/1408093/51537603-44fa1300-1e4f-11e9-84f2-eb7d4c6fc7ef.gif" alt="Fuzzy symbol search example"></p><p>The search is fuzzy, meaning the query doesn&#x27;t have to be an exact match or a
substring match with the target symbol. For example, we want the query <code>ReaSer</code>
to match the symbol <code>ReactDOMServer</code>. Additionally, all-lowercase queries are
treated as case-insensitive so that searching for <code>nelis</code> matches the symbol
<code>NonEmptyList</code>.</p><p>Like with find symbol references, the challenge when implementing fuzzy symbol
search is that we have little time to respond and a lot of symbols to search.
Testing¬†the search query against every source file the workspace and every entry
in the library classpath is too slow.</p><p>Metals uses bloom filters to reduce the search space so that we only look at
places that are likely to contain matches for the query. We have two different
indexes, one for workspace sources and another one for the library classpath.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="workspace-sources"></a>Workspace sources<a class="hash-link" href="#workspace-sources" title="Direct link to heading">#</a></h3><p>The first index is a map keyed by source files in the workspace.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val inWorkspace: Map[Path, BloomFilter[String]]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The values of the map is the set of all possible sub-queries that match symbols
defined in that source file. For example, consider the code below.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">package data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class NonEmptyListSpec { ... }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">object Props { ... }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>For this source file, we insert the following sub-queries into the index.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly txt"><div tabindex="0" class="prism-code language-txt codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">d</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">da</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dat</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">N</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">No</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Non</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">L</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Li</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Lis</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">List</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Sp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Spe</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Spec</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NEL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NES</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ELS</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">P</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Pr</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Pro</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Prop</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Props</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>When searching for a query like <code>NoLi</code>, we split the query into the words <code>No</code>
and <code>Li</code> and visit only files whose bloom filter contains all of those exact
sub-queries. We include trigrams of the uppercase characters to further reduce
the search space for queries like <code>NELS</code> that have few lowercase character.</p><p>For all-lowercase queries, we return the union of results from multiple
capitalization combinations in order to support case-insensitive searches. For
example, the query <code>neli</code> returns all results matching any of the following
queries.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly txt"><div tabindex="0" class="prism-code language-txt codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">neli</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Neli</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NEli</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NeLi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NelI</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NELi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NElI</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NeLI</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NELI</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>To implement the search, we iterate through all entries of the in-memory map and
only visit the source files on disk whose bloom filter contain a match for the
query.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val query = ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">for {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (file, bloom) &lt;- inWorkspace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if bloom.mightContain(query)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  symbol &lt;- parseSymbols(file) // reads from disk</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if isFuzzyMatch(query, symbol)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} yield symbol</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Like with find symbol references, false positive results from the bloom filter
slow down the response but don&#x27;t compromise the correctness of the result. Also,
we incrementally update the map as files in the workspace change by removing old
entries and compute a new bloom filter for the updated source file.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="library-classpath"></a>Library classpath<a class="hash-link" href="#library-classpath" title="Direct link to heading">#</a></h3><p>The library classpath index is similar to the workspace sources index except the
keys of the map are package symbols (example <code>scala/collection/</code>) instead of
file paths.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val inClasspath: Map[Symbol, (BloomFilter[String], Seq[Symbol])]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Unlike the workspace sources index, the library classpath index does not need to
be incrementally updated when files re-compile. The bloom filters in the values
of the map use the same sub-query technique as the bloom filters in the
workspace sources index. For each bloom filter, we additionally store a listing
of all members of that package. If a query matches a given bloom filter, we test
the fuzzy search against all members of the package.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val query = ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">for {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (pkg, (bloom, packageMembers)) &lt;- inClasspath</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if bloom.mightContain(query)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  member &lt;- packageMembers</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if isFuzzyMatch(query, symbol(pkg, member))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  definitionOnDisk &lt;- findDefinition(member) // writes to disk</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} yield definitionOnDisk</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Due to how the Language Server Protocol works, the <code>findDefinition</code> method
writes sources of library dependencies to disk so the editor can find the symbol
definition location. To reduce the number of files written to disk, Metals
limits the number of non-exact search results from the library classpath index.</p><p>In the actual Metals implementation, the listing of package members is GZIP
compressed to reduce memory usage and the members are decompressed on-demand
when a bloom filter matches the query.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="evaluation"></a>Evaluation<a class="hash-link" href="#evaluation" title="Direct link to heading">#</a></h2><p>We test Metals on the <a href="https://github.com/akka/akka" target="_blank" rel="noopener noreferrer">Akka codebase</a> to evaluate
the performance of our bloom filter indexes. Akka is a library to build highly
concurrent, distributed, and resilient message-driven applications on the JVM.</p><p><img src="https://user-images.githubusercontent.com/1408093/51541018-159bd400-1e58-11e9-9181-cf2e32a0a40b.png" alt="Akka repository"></p><p>The Akka codebase has 300-600k lines of code depending on whether you include
comments and/or Java sources. Metals indexes both Java and Scala sources for
fuzzy symbol search but only Scala sources for find symbol references.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ git clone https://github.com/akka/akka.git</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ cd akka</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ loc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Language  Files    Lines   Blank  Comment     Code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Scala     1,951  358,149  57,528   76,605  224,016</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Java        486  250,609  19,838   51,291  179,480</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>We open the base directory with Visual Studio Code and update the &quot;Metals Server
Properties&quot; setting to <code>-Dmetals.statistics=all</code> to enable additional
logging¬†output. We import the build, open the file <code>Actor.scala</code> and wait until
compilation has finished. It is normal if this step takes several minutes to
complete.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="response-times"></a>Response times<a class="hash-link" href="#response-times" title="Direct link to heading">#</a></h3><p>First, we measure the response times for find symbol references.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: found 8 references to symbol &#x27;akka/actor/ActorCell.contextStack.&#x27; in 8ms</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: found 11 references to symbol &#x27;akka/actor/Actor#postRestart().&#x27; in 17ms</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: found 146 references to symbol &#x27;akka/actor/PoisonPill.&#x27; in 0.16s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: found 163 references to symbol &#x27;scala/collection/IterableLike#head().&#x27; in 0.23s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: found 1027 references to symbol &#x27;akka/actor/Actor#&#x27; in 0.5s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: found 816 references to symbol &#x27;scala/package.Throwable#&#x27; in 0.63s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: found 6103 references to symbol &#x27;scala/Predef.String#&#x27; in 1.54s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Response times range from 8ms up to 1.6s depending on the number of results. The
6103 references to <code>String</code> origin from 913 source files, which is almost half
of all Scala source files in the repository. These numbers do not take into
account the delay in the editor to display the results in the UI. For large
results like <code>String</code>, this delay can be several seconds depending on the
editor.</p><p>Next, we measure the response times for fuzzy symbol search.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: found 0 results for query &#x27;ConfigSEr&#x27; in 13ms</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: found 10 results for query &#x27;ConfigSer&#x27; in 0.1s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: found 105 results for query &#x27;ActorRef&#x27; in 0.21s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: found 105 results for query &#x27;actorref&#x27; in 0.31s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: found 1002 results for query &#x27;actor&#x27; in 0.54s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: found 3974 results for query &#x27;S&#x27; in 1.98s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Response times range from 13ms up to 2s depending on the query and number of
results. Queries with typos like <code>ConfigSEr</code> have 0 results and respond
instantly, while generic queries like <code>S</code> have ~4k results and take 2 seconds to
respond. Observe that all-lowercase queries like <code>actorref</code> are slower than
capitalized queries like <code>ActorRef</code>, which is expected because we test multiple
capitalization combinations for case-insensitive searches.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="memory-usage"></a>Memory usage<a class="hash-link" href="#memory-usage" title="Direct link to heading">#</a></h3><p>Next, we look at the memory usage of the bloom filter indexes. The numbers are
computed with <a href="https://openjdk.java.net/projects/code-tools/jol/" target="_blank" rel="noopener noreferrer">JOL</a>
<code>GraphLayout</code> and the element counts are approximate number of insertions into
the bloom filters.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">memory: references index using 3.72M (274,747 elements)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">memory: workspace symbol index using 1.89M (173,419 elements)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">memory: classpath symbol index using 1.72M (382,243 elements)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The three bloom filter indexes use 8Mb combined for the entire Akka build. The
8Mb include the maps with file/symbol keys and also a GZIP compressed listing of
package members for the classpath symbol index. For comparison, the
<a href="https://scalameta.org/metals/blog/2018/12/12/fast-goto-definition.html" target="_blank" rel="noopener noreferrer">goto definition index</a>
that does not use bloom filters requires 16Mb alone.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">memory: definition index using 15.9M (337,532 lines Scala)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="indexing-time"></a>Indexing time<a class="hash-link" href="#indexing-time" title="Direct link to heading">#</a></h3><p>Next, we look at the time it takes to construct the indexes after build import.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: imported build in 2.41s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: updated build targets in 0.12s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: started file watcher in 4.36s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: indexed library classpath in 0.8s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: indexed workspace SemanticDBs in 2.18s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: indexed workspace sources in 3.35s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">time: indexed library sources in 1.59s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The Akka build contains many source files but few library dependencies. The
bottle-neck appears to be starting the file watcher and parsing all <code>*.scala</code>
and <code>*.java</code> sources in the workspace. The following flamegraph shows a detailed
breakdown of what goes on during indexing.</p><p><img src="https://i.imgur.com/Xhr1wXp.jpg" alt="Akka indexing flamegraph">(<a href="https://geirsson.com/assets/metals-akka-initialize.svg" target="_blank" rel="noopener noreferrer">https://geirsson.com/assets/metals-akka-initialize.svg</a>)</p><blockquote><p>Click on image to interactively explore the flamegraph.</p></blockquote><p>Some observations:</p><ul><li>it&#x27;s slower to start the file watcher than compute all three indexes for find
symbol references and fuzzy symbol search, combined.</li><li>the method <code>BloomFilter.put()</code> accounts for 2.26% of the total runtime.</li></ul><p>For comparison, below is another flamegraph for the same indexing pipeline but
in a different project, <a href="https://github.com/prisma/prisma" target="_blank" rel="noopener noreferrer">Prisma</a>. The total
indexing time is around 8 seconds on a cold server for both Akka and Prisma but
the distribution is different for how long each indexing task takes. Prisma has
fewer sources (80k lines of Scala code, no Java) and a larger number of library
dependencies compared to Akka.</p><p><img src="https://i.imgur.com/JR3SNx6.jpg" alt="Prisma indexing flamegraph">(<a href="https://geirsson.com/assets/metals-prisma-initialize.svg" target="_blank" rel="noopener noreferrer">https://geirsson.com/assets/metals-prisma-initialize.svg</a>)</p><blockquote><p>Click on image to interactively explore the flamegraph.</p></blockquote><p>Computing the bloom filter indexes for find symbol references and fuzzy symbol
search takes proportionally even less time in Prisma compared to Akka. The
Prisma project is a good representation¬†for projects with less than 100k lines
of code and a large number of library dependencies.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>Metals uses three bloom filter indexes to implement the features &quot;find symbol
references&quot; and &quot;fuzzy symbol search&quot;. On a case study project containing 600k
lines of code, all three indexes use 8Mb of memory combined and enable
sub-second response times for most user requests. Response times for fuzzy
symbol search is occasionally slower for short queries like <code>S</code> but this
limitation is not inherent with the bloom filter indexing approach and may be
addressed in future releases.</p><p>Computing the bloom filter indexes takes 4s in our case-study project, out of
total 16s for the combined &quot;import build&quot; and &quot;indexing&quot; steps. These steps run
whenever Metals starts in an existing project or after the build changes. Can
indexing be made faster? Probably yes, but the user experience will still remain
bottle-necked by sbt build export and compilation of workspace sources, which
frequently take many minutes¬†to complete on large projects.</p><p>The indexes are in-memory maps where the keys are file paths and values are
bloom filters. When files change, we can incrementally update the indexes¬†by
computing a new bloom filter for the updated source file.</p><p>The bloom filter indexes are only used to narrow down the search space by
eliminating files and packages that don&#x27;t contain relevant results for the user
query. False positive results slow down response times but don&#x27;t compromise the
correctness of the final result.</p><p>Try out Metals today with VS Code, Atom, Vim, Sublime Text or Emacs using the
installation instructions here
<a href="https://scalameta.org/metals/docs/editors/overview.html" target="_blank" rel="noopener noreferrer">https://scalameta.org/metals/docs/editors/overview.html</a>.</p><p>The indexer is working when the status bar says <code>Indexing‚†ã</code>
<img src="https://i.imgur.com/6VLPu9c.gif" alt="Indexing status bar"></p></div></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/metals/blog/2019/01/24/tin"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">¬´ Metals v0.4.0 - Tin</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/metals/blog/2018/12/14/iron"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Metals v0.3.2 - Iron ¬ª</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#bloom-filters" class="table-of-contents__link">Bloom filters</a></li><li><a href="#find-symbol-references" class="table-of-contents__link">Find symbol references</a></li><li><a href="#fuzzy-symbol-search" class="table-of-contents__link">Fuzzy symbol search</a><ul><li><a href="#workspace-sources" class="table-of-contents__link">Workspace sources</a></li><li><a href="#library-classpath" class="table-of-contents__link">Library classpath</a></li></ul></li><li><a href="#evaluation" class="table-of-contents__link">Evaluation</a><ul><li><a href="#response-times" class="table-of-contents__link">Response times</a></li><li><a href="#memory-usage" class="table-of-contents__link">Memory usage</a></li><li><a href="#indexing-time" class="table-of-contents__link">Indexing time</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Overview</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/metals/docs/overview/editor-support">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/metals/docs/build-tools/overview">Build Tools</a></li><li class="footer__item"><a class="footer__link-item" href="/metals/docs/contributors/project-goals">Project Goals</a></li><li class="footer__item"><a class="footer__link-item" href="/metals/docs/contributors/getting-started">Contributing</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/scalameta/metals" target="_blank">
                      <img src="https://img.shields.io/github/stars/scalameta/metals.svg?color=%23087e8b&label=stars&logo=github&style=social">
                    </a></li><li class="footer__item"><a href="https://discord.gg/RFpSVth" target="_blank">
                      <img src="https://img.shields.io/discord/632642981228314653?logo=discord&style=social">
                    </a></li><li class="footer__item"><a href="https://gitter.im/scalameta/metals" target="_blank">
                      <img src="https://img.shields.io/gitter/room/scalameta/metals.svg?logo=gitter&style=social">
                    </a></li><li class="footer__item"><a href="https://twitter.com/scalameta" target="_blank">
                      <img src="https://img.shields.io/twitter/follow/scalameta.svg?logo=twitter&style=social">
                    </a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/metals/img/scalameta-logo.png" alt="" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/metals/img/scalameta-logo.png" alt="" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></div><div class="footer__copyright">Copyright ¬© 2021 Metals</div></div></div></footer></div>
<script src="/metals/assets/js/runtime~main.4cac7cd7.js"></script>
<script src="/metals/assets/js/main.3a707c2e.js"></script>
</body>
</html>