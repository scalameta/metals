<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Fast goto definition with low memory footprint | Metals</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://scalameta.org/metals/img/scalameta-logo.png"><meta data-rh="true" name="twitter:image" content="http://scalameta.org/metals/img/scalameta-logo.png"><meta data-rh="true" property="og:url" content="http://scalameta.org/metals/blog/2018/12/12/fast-goto-definition"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Fast goto definition with low memory footprint | Metals"><meta data-rh="true" name="description" content="Metals throws away its navigation index when it shuts down. Next time it starts,"><meta data-rh="true" property="og:description" content="Metals throws away its navigation index when it shuts down. Next time it starts,"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2018-12-12T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://twitter.com/olafurpg"><link data-rh="true" rel="icon" href="/metals/img/favicon.ico"><link data-rh="true" rel="canonical" href="http://scalameta.org/metals/blog/2018/12/12/fast-goto-definition"><link data-rh="true" rel="alternate" href="http://scalameta.org/metals/blog/2018/12/12/fast-goto-definition" hreflang="en"><link data-rh="true" rel="alternate" href="http://scalameta.org/metals/blog/2018/12/12/fast-goto-definition" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/metals/blog/rss.xml" title="Metals RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/metals/blog/atom.xml" title="Metals Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-140140828-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-140140828-1",{})</script><link rel="stylesheet" href="/metals/assets/css/styles.5f8867dd.css">
<script src="/metals/assets/js/runtime~main.8819204d.js" defer="defer"></script>
<script src="/metals/assets/js/main.356d7e2b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/metals/"><div class="navbar__logo"><img src="/metals/img/scalameta-logo.png" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/metals/img/scalameta-logo.png" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Metals</b></a><a class="navbar__item navbar__link" href="/metals/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/metals/blog/">Blog</a><a href="https://github.com/scalameta/metals" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All Blog Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2023/12/12/bismuth">Metals v1.2.0 - Bismuth</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2023/10/17/silver">Metals v1.1.0 - Silver</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2023/08/28/silver">Metals v1.0.1 - Silver</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2023/07/19/silver">Metals v1.0.0 - Silver</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2023/07/17/workspace-folders">Workspace folders</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2023/04/21/aluminium">Metals v0.11.12 - Aluminium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2023/03/02/aluminium">Metals v0.11.11 - Aluminium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2023/01/02/aluminium">Metals v0.11.10 - Aluminium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2022/10/06/aluminium">Metals v0.11.9 - Aluminium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2022/08/10/aluminium">Metals v0.11.8 - Aluminium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2022/07/04/aluminium">Metals v0.11.7 - Aluminium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2022/06/03/aluminium">Metals v0.11.6 - Aluminium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2022/04/28/aluminium">Metals v0.11.5 - Aluminium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2022/04/27/aluminium">Metals v0.11.4 - Aluminium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2022/04/26/aluminium">Metals v0.11.3 - Aluminium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2022/03/08/aluminium">Metals v0.11.2 - Aluminium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2022/02/23/towards-better-releases">Towards better releases</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2022/01/17/aluminium">Metals v0.11.1 - Aluminium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2022/01/12/aluminium">Metals v0.11.0 - Aluminium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2021/11/03/tungsten">Metals v0.10.9 - Tungsten</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2021/10/26/tungsten">Metals v0.10.8 - Tungsten</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2021/09/16/tungsten">Metals v0.10.7 - Tungsten</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2021/09/06/tungsten">Metals v0.10.6 - Tungsten</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2021/07/14/tungsten">Metals v0.10.5 - Tungsten</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2021/05/31/tungsten">Metals v0.10.4 - Tungsten</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2021/05/17/tungsten">Metals v0.10.3 - Tungsten</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2021/04/20/tungsten">Metals v0.10.2 - Tungsten</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2021/04/06/tungsten">Metals v0.10.1 - Tungsten</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2021/02/24/tungsten">Metals v0.10.0 - Tungsten</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2021/02/02/metals-retro-part1">A Metals Retrospective (Part 1)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2021/01/19/lithium">Metals v0.9.10 - Lithium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/12/19/lithium">Metals v0.9.8 - Lithium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/11/26/lithium">Metals v0.9.7 - Lithium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/11/20/lithium">Metals v0.9.6 - Lithium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/11/10/lithium">Metals v0.9.5 - Lithium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/11/06/sbt-BSP-support">sbt BSP support</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/09/21/lithium">Metals v0.9.4 - Lithium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/08/19/lithium">Metals v0.9.3 - Lithium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/07/23/configuring-a-client">A Dive into Configuring Metals</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/07/15/lithium">Metals v0.9.2 - Lithium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/07/01/lithium">Metals v0.9.1 - Lithium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/05/04/lithium">Metals v0.9.0 - Lithium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/04/10/cobalt">Metals v0.8.4 - Cobalt</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/03/19/cobalt">Metals v0.8.3 - Cobalt</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/02/26/cobalt">Metals v0.8.1 - Cobalt</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2020/01/10/cobalt">Metals v0.8.0 - Cobalt</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2019/09/23/thorium">Metals v0.7.6 - Thorium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2019/09/12/thorium">Metals v0.7.5 - Thorium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2019/09/02/thorium">Metals v0.7.2 - Thorium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2019/06/28/thorium">Metals v0.7.0 - Thorium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2019/06/11/radium">Metals v0.6.1 - Radium</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2019/04/26/mercury">Metals v0.5.1 - Mercury</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2019/04/12/mercury">Metals v0.5.0 - Mercury</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2019/02/01/tin">Metals v0.4.4 - Tin</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2019/01/24/tin">Metals v0.4.0 - Tin</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2019/01/22/bloom-filters">Low-memory symbol indexing with bloom filters</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2018/12/14/iron">Metals v0.3.2 - Iron</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/metals/blog/2018/12/12/fast-goto-definition">Fast goto definition with low memory footprint</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/metals/blog/2018/12/06/iron">Metals v0.3 - Iron</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Metals throws away its navigation index when it shuts down. Next time it starts,"><header><h1 class="title_f1Hy" itemprop="headline">Fast goto definition with low memory footprint</h1><div class="container_mt6G margin-vert--md"><time datetime="2018-12-12T00:00:00.000Z" itemprop="datePublished">December 12, 2018</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/olafurpg" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/1408093?s=460&amp;v=4" alt="Ólafur Páll Geirsson" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/olafurpg" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Ólafur Páll Geirsson</span></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Metals throws away its navigation index when it shuts down. Next time it starts,
the index is computed again from scratch. Although this approach is simple, it
requires indexing to be fast enough so you don&#x27;t mind running it again and
again. Also, because we don&#x27;t persist the index to disk, we need to be careful
with memory usage.</p>
<p>This post covers how Metals achieves fast source indexing for Scala with a small
memory footprint. We describe the problem statement, explain the initial
solution and how an optimization delivered a 10x speedup. Finally, we evaluate
the result on a real-world project.</p>
<p>The work presented in this post was done as part of my job at the
<a href="https://scala.epfl.ch/" target="_blank" rel="noopener noreferrer">Scala Center</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="problem-statement">Problem statement<a href="#problem-statement" class="hash-link" aria-label="Direct link to Problem statement" title="Direct link to Problem statement">​</a></h2>
<p>What happens when you run Goto Definition? In reality, a lot goes on but in this
post we&#x27;re gonna focus on a specific problem: given a method like
<code>scala.Some.isEmpty</code> and many thousand source files with millions of lines of
code, how do we quickly find the source file that defines that method?</p>
<p><img loading="lazy" src="https://user-images.githubusercontent.com/1408093/49591684-67070700-f96f-11e8-873d-90c40480528b.gif" alt="goto-definition" class="img_ev3q"></p>
<p>There are some hard constraints:</p>
<ul>
<li>we must answer quickly, normal requests should respond within 100-200ms.</li>
<li>memory usage should not exceed 10-100Mb since we also need memory to implement
other features and we&#x27;re sharing the computer with other applications.</li>
<li>computing an index should not take more than ~10 seconds after importing the
build, even for large projects with millions of lines of source code
(including dependencies).</li>
</ul>
<p>To keep things simple, imagine we have all source files available in a directory
that we can walk and read.</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">walk()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Stream(&quot;scala/Option.scala&quot;, &quot;scala/Predef.scala&quot;, ...)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">read(&quot;scala/Option.scala&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// &quot;sealed abstract class Option { ... }; class Some extends Option { ... }&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="java">Java<a href="#java" class="hash-link" aria-label="Direct link to Java" title="Direct link to Java">​</a></h3>
<p>For Java, the challenge is not so difficult since the compiler enforces that
each source file contains a single public class with matching filename.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// java/nio/file/Files.java</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">package java.nio.file;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">public class Files {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public static byte[] readAllBytes(path: Path) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      // ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To respond to a Goto Definition request for the <code>Files.readAllBytes</code> method, we</p>
<ul>
<li>take the enclosing toplevel class <code>java.nio.file.Files</code></li>
<li>read the corresponding file <code>java/nio/File/Files.java</code></li>
<li>parse <code>Files.java</code> to find the exact position of <code>readAllBytes</code></li>
</ul>
<p>This approach is fast (parsing one file is cheap) and it also requires no index
(0Mb memory!).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scala">Scala<a href="#scala" class="hash-link" aria-label="Direct link to Scala" title="Direct link to Scala">​</a></h3>
<p>For Scala, the problem is trickier because the compiler allows multiple toplevel
classes in the same source file.</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// scala/Option.scala</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">package scala</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sealed abstract class Option[+T] { /* ... */ }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">final class Some[+T](value: T) extends Option[T] {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def isEmpty = false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To navigate to the <code>scala.Some.isEmpty</code> method we can&#x27;t use the same approach as
in Java because the class <code>scala.Some</code> is in <code>scala/Option.scala</code>, not
<code>scala/Some.scala</code>.</p>
<p>One possible solution is to read the <code>scala/Some.class</code> classfile that contains
the filename <code>Option.scala</code> where <code>scala.Some</code> is defined.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ javap -classpath $(coursier fetch org.scala-lang:scala-library:2.12.8) scala.Some</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Compiled from &quot;Option.scala&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>However, source information in classfiles is not always reliable and it may be
removed by tools that process jar files. Let&#x27;s restrict the problem to only use
source files.</p>
<p>Instead of using JVM classfiles, we can walk all Scala source files and build an
index that maps toplevel classes to the source file that defines that class. The
index looks something like this:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">val index = Map[Symbol, Path](</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Symbol(&quot;scala.Some&quot;) -&gt; Path(&quot;scala/Option.scala&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With this index, we find the definition of <code>Some.isEmpty</code> using the same steps
as for <code>Files.readAllBytes</code> in Java:</p>
<ul>
<li>take the enclosing toplevel class <code>scala.Some</code></li>
<li>query index to know that <code>scala.Some</code> is defined in <code>scala/Option.scala</code></li>
<li>parse <code>scala/Option.scala</code> to find exact position of <code>isEmpty</code> method.</li>
</ul>
<p>The challenge is to efficiently build the index.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="initial-solution">Initial solution<a href="#initial-solution" class="hash-link" aria-label="Direct link to Initial solution" title="Direct link to Initial solution">​</a></h2>
<p>One approach to build the index is to use the
<a href="https://scalameta.org/" target="_blank" rel="noopener noreferrer">Scalameta</a> parser to extract the toplevel classes of
each source file. This parser does not desugar the original code making it
useful for refactoring and code-formatting tools like
<a href="http://scalacenter.github.io/scalafix/" target="_blank" rel="noopener noreferrer">Scalafix</a>/<a href="http://scalameta.org/scalafmt" target="_blank" rel="noopener noreferrer">Scalafmt</a>.
I&#x27;m also familiar with Scalameta parser API so it was fast to get a working
implementation. However, is the parser fast enough to parse millions of lines of
code on every server startup?</p>
<p>According to JMH benchmarks, the Scalameta parser handles ~92k lines/second
measured against a sizable corpus of Scala code. The benchmarks use the
&quot;single-shot&quot; mode of JMH, for which the documentation says:</p>
<blockquote>
<p>&quot;This mode is useful to estimate the &quot;cold&quot; performance when you don&#x27;t want to
hide the warmup invocations.&quot;</p>
</blockquote>
<p>Cold performance is an OK estimate for our use-case since indexing happens
during server startup.</p>
<p>The Scala standard library is ~36k lines so at 92k lines/second this solution
scales up to a codebase with up to 20-30 similarly-sized library dependencies.
If we add more library dependencies, we exceed the 10 second constraint for
indexing time. For a codebase with 5 million lines of code, users might have to
wait one minute for indexing to complete. We should aim for better.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="optimized-solution">Optimized solution<a href="#optimized-solution" class="hash-link" aria-label="Direct link to Optimized solution" title="Direct link to Optimized solution">​</a></h2>
<p>We can speed up indexing by writing a custom parser that extracts only the
information we need from a source file. For example, the Scalameta parser
extracts method implementations that are irrelevant for our indexer. Our indexer
needs to know the toplevel classes and nothing more.</p>
<p>The simplified algorithm for this custom parser goes something like this:</p>
<ul>
<li>tokenize source file</li>
<li>on consecutive <code>package object</code> keywords, record package object</li>
<li>on <code>package</code> keyword, record package name</li>
<li>on <code>class</code> and <code>trait</code> and <code>object</code> keywords, record toplevel class</li>
<li>on <code>(</code> and <code>[</code> and <code>{</code> delimiters, skip tokens until we find matching closing
delimiter</li>
</ul>
<p>There are a few more cases to handle, but the implementation ended up being ~200
lines of code that took an afternoon to write and test (less time than it took
to write this blog post!).</p>
<p>Benchmarks show that the custom parser is almost 10x faster compared to the
initial solution.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[info] Benchmark                  Mode  Cnt  Score   Error  Units</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[info] MetalsBench.toplevelParse    ss   30  0.349 ± 0.003   s/op</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[info] MetalsBench.scalametaParse   ss   30  3.370 ± 0.175   s/op</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At ~920k lines/second it takes ~6 seconds to index a codebase with 5 million
lines of code, a noticeable improvement to the user experience compared to the
one minute it took with the previous solution.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="evaluation">Evaluation<a href="#evaluation" class="hash-link" aria-label="Direct link to Evaluation" title="Direct link to Evaluation">​</a></h2>
<p>Micro-benchmarks are helpful but they don&#x27;t always reflect user experience. To
evaluate how our indexer performs in the real world, we test Metals on the
<a href="https://www.prisma.io/" target="_blank" rel="noopener noreferrer">Prisma</a> codebase. Prisma is a server implemented in
Scala that replaces traditional ORMs and data access layers with a universal
database abstraction.</p>
<p><img loading="lazy" src="https://user-images.githubusercontent.com/1408093/49875321-08cf9d80-fe21-11e8-9f02-54ff4960a7af.png" alt="prisma" class="img_ev3q"></p>
<p>The project has around 80k lines of Scala code.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ git clone https://github.com/prisma/prisma.git</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ cd prisma/server</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ loc</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Language             Files        Lines        Blank      Comment         Code</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Scala                  673        88730        12811         1812        74107</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We open VS Code with the Metals extension, enable the server property
<code>-Dmetals.statistics=all</code> and import the build.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ tail -f .metals/metals.log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">time: ran &#x27;sbt bloopInstall&#x27; in 1m4s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">time: imported workspace in 13s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">memory: index using 13.1M (923,085 lines Scala)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We run &quot;Import build&quot; again to get a second measurement.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">time: ran &#x27;sbt bloopInstall&#x27; in 41s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">time: imported workspace in 7s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">memory: index using 13.1M (990,144 Scala)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><strong>&quot;ran &#x27;sbt bloopInstall&#x27;&quot;</strong>: the time it takes to dump the sbt build
structure with <a href="https://scalacenter.github.io/bloop/" target="_blank" rel="noopener noreferrer">Bloop</a>, the build server
used by Metals.<!-- -->
<ul>
<li>The Prisma build has 44 sbt projects.</li>
<li>Running <code>sbt</code> takes 23 seconds to reach the sbt shell.</li>
</ul>
</li>
<li><strong>&quot;imported workspace&quot;</strong>: the time it takes to import the build structure into
Metals and index sources of all projects, including the following steps:<!-- -->
<ol>
<li>Query Bloop for the dumped build structure, listing all project
dependencies, sources and compiler options.</li>
<li>Walk, read and index all Scala sources in the workspace, happens in both
runs.</li>
<li>Walk, read and index all library dependency sources, happens only for the
first run since the indexer caches <code>*-sources.jar</code> file results.</li>
</ol>
<ul>
<li>It&#x27;s expected that &quot;lines of code&quot; increased by ~70k lines in the second run
since we indexed the workspace sources again.</li>
<li>It&#x27;s expected that indexing was faster in the second run since indexes are
cached for <code>*-sources.jar</code> files and the JVM has also warmed up.</li>
</ul>
</li>
<li><strong>&quot;index using 13.1M&quot;</strong>: the memory footprint of the index mapping toplevel
Scala classes to which file they are defined in.<!-- -->
<ul>
<li>Memory is measured using
<a href="https://openjdk.java.net/projects/code-tools/jol/" target="_blank" rel="noopener noreferrer">OpenJDK JOL</a>
<code>GraphLayout.totalSize()</code>.</li>
<li>Note that the server uses more memory in total, this is only for the
navigation index.</li>
<li>The index does not contain entries where the toplevel classname matches the
filename, for the same reason we don&#x27;t index Java sources.</li>
</ul>
</li>
</ul>
<p>On average, Goto Definition responds well within our 100ms goal.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">time: definition in 0.03s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">time: definition in 0.02s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>However, occasional definition requests take much longer to respond.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">info  time: definition in 8s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">info  time: definition in 0.62s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The outliers happen when navigating inside library dependency sources, which is
expected to be slower since we need to type-check those sources before querying
the index.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>Metals uses a custom Scala parser to index sources at roughly 1 million
lines/second in micro-benchmarks. The index is used to quickly respond to Goto
Definition requests. On a case-study project containing 44 modules and ~900k
lines of Scala sources (including library dependencies), it takes ~10 seconds to
import the build structure (including source indexing) and the resulting index
uses 13M memory.</p>
<p>The Java+Scala source indexers used by Metals are available in a standalone
library called mtags.</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">libraryDependencies += &quot;org.scalameta&quot; %% &quot;mtags&quot; % &quot;0.3.1&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The mtags library is already being used by the
<a href="http://almond-sh.github.io/almond/stable/docs/intro" target="_blank" rel="noopener noreferrer">Almond Scala kernel for Jupyter</a>
to support Goto Definition inside Jupyter notebooks.</p>
<p>Can the indexer become faster? Sure, I suspect there&#x27;s still room for 2-3x
speedups with further optimizations. However, I&#x27;m not convinced it will make a
significant improvement to the user experience since we remain bottle-necked by
dumping sbt build structure and compiling the sources.</p>
<p>Try out Goto Definition with Metals today using VS Code, Atom, Vim, Sublime Text
or Emacs using the installation instructions here:
<a href="https://scalameta.org/metals/docs/editors/overview.html" target="_blank" rel="noopener noreferrer">https://scalameta.org/metals/docs/editors/overview.html</a>. The indexer is working
when you see &quot;Importing build&quot; in the status bar
<img loading="lazy" src="https://user-images.githubusercontent.com/1408093/49924982-f5234600-feb7-11e8-9edd-715388bb546f.gif" alt="imageedit_3_3576623823" class="img_ev3q"></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/metals/blog/2018/12/14/iron"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Metals v0.3.2 - Iron</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/metals/blog/2018/12/06/iron"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Metals v0.3 - Iron</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#problem-statement" class="table-of-contents__link toc-highlight">Problem statement</a><ul><li><a href="#java" class="table-of-contents__link toc-highlight">Java</a></li><li><a href="#scala" class="table-of-contents__link toc-highlight">Scala</a></li></ul></li><li><a href="#initial-solution" class="table-of-contents__link toc-highlight">Initial solution</a></li><li><a href="#optimized-solution" class="table-of-contents__link toc-highlight">Optimized solution</a></li><li><a href="#evaluation" class="table-of-contents__link toc-highlight">Evaluation</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Overview</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/metals/docs/overview/editor-support">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/metals/docs/build-tools/overview">Build Tools</a></li><li class="footer__item"><a class="footer__link-item" href="/metals/docs/contributors/project-goals">Project Goals</a></li><li class="footer__item"><a class="footer__link-item" href="/metals/docs/contributors/getting-started">Contributing</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/scalameta/metals" target="_blank">
                      <img src="https://img.shields.io/github/stars/scalameta/metals.svg?color=%23087e8b&label=stars&logo=github&style=social">
                    </a></li><li class="footer__item"><a href="https://discord.gg/RFpSVth" target="_blank">
                      <img src="https://img.shields.io/discord/632642981228314653?logo=discord&style=social">
                    </a></li><li class="footer__item"><a href="https://twitter.com/scalameta" target="_blank">
                      <img src="https://img.shields.io/twitter/follow/scalameta.svg?logo=twitter&style=social">
                    </a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/metals/img/scalameta-logo.png" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/metals/img/scalameta-logo.png" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></div><div class="footer__copyright">Copyright © 2024 Metals</div></div></div></footer></div>
</body>
</html>